# Istio笔记

## 一、相关概念

软件是当今公司的命脉。随着我们进入一个更加数字化的世界，消费者在与企业交互时期待获得便利的高质量服务，而软件将被用作传递这种体验的媒介。客户不能很好地遵守结构、流程或预定义的框架。客户的需求和需要是流动的、动态的和不可预测的，我们的公司和软件系统也需要具有这些相同的特征。对于有些公司（比如初创公司）来说，能否构建灵活的、能够应对不可预测的市场环境的软件系统，将决定其成败。对于其他公司（比如现有的公司）来说，若不能将软件作为一种区分标准，则将意味着增长放缓、衰落，并最终倒闭。

服务网格是一个相对较新的术语，用来描述分布式应用程序网络基础设施，让应用程序安全、有弹性、可观测和可控制。它描述了一个由数据平面和控制平面组成的架构，数据平面使用应用层代理来管理网络流量，控制平面用于管理代理。这种架构使我们能够在应用程序之外构建网络功能，而无须依赖特定的编程语言或框架。

- 什么是服务网格，为什么需要使用服务网格
    - 服务网格可以最大限度地提高整个组织的开发速度，它支持数千个独立的微服务，这些微服务自动支持扩缩容策略
    - 为了将应用程序与基础设施解耦，Istio是朝着这个方向迈出的第三步
    - 第一步，Docker提供了一种将应用程序(及其依赖库)与运行它的机器分开打包的方法
    - 第二步，Kubernetes使创建自动化服务变得很容易，以帮助实现服务自动伸缩和管理
    - Docker和Kubernetes共同推动了微服务的实际改造迁移运动，而通过Istio，则得以实现第三步：应用程序解耦
    - 但是实现服务快速迭代不仅仅是将其与机器分离，服务还必须与共享策略解耦。每个企业都有适用于所有服务的策略，一般情况下这些策略被嵌入服务中，作为代码的一部分，或者作为服务依赖的库。无论怎样，这些策略都很难被更新并重新执行。
    - Istio将大量流量控制策略(主要是涉及API的策略)从应用服务转移到服务网格中，通过部署在服务前的代理来实现。当正确完成这一操作时，所有的服务不需要做额外工作就能满足这些策略，而且更改策略也不需要更新应用服务。这就是我们追求的解耦。

- 转移到，面向服务的架构(SOA)时，必须要解决的问题：
    - 防止故障超出隔离边界。
    - 构建能够响应环境变化的应用程序/服务。
    - 建立能够在部分失效条件下运行的系统。
    - 理解整个系统在不断变化和发展时发生了什么。
    - 无法控制系统的运行时行为。
    - 随着攻击面的增加，加强安全防护。
    - 降低系统变更产生的风险。
    - 执行关于谁、什么东西可以使用系统组件，以及何时可以使用系统组件的策略。

- 有些模式已经发展起来了，可以缓解应用程序的这类问题，使应用程序更有弹性，以应对计划外的、意想不到的故障：
    - 客户端负载均衡——为客户端提供可能的端点列表，并让它决定调用哪一个。
    - 服务发现——一种用于查找特定逻辑服务端点列表的机制，这些端点是健康的且定期更新。
    - 熔断——在一段时间内对表现异常的服务进行屏蔽。
    - bulkheading——在调用服务时，使用显式的阈值（连接、线程、会话等）限制客户端资源的使用。
    - 超时——在调用服务时，对Request、Socket、Liveness等执行时间限制。
    - 重试——重试失败的请求。
    - 重试限制——对重试的次数进行限制：限制在给定的时间段内重试的次数（例如，在10s的窗口内，只有50%的请求重试）。
    - 最后期限——给出请求上下文，说明一个响应可以持续多久；如果超过了最后期限，就不再处理请求。
    - 总的来说，这些类型的模式可以被认为是应用程序网络。它们与网络栈较低层的类似结构有很多重叠之处，只不过它们是在消息层而不是在包层操作的。

- [服务网格 Istio](https://istio.io)
- [academy](https://academy.tetrate.io/)
- [EBook istio-in-action](https://livebook.manning.com/book/istio-in-action)
- [Manning 网站](https://www.manning.com)
- [book-source-code](https://github.com/istioinaction/book-source-code)
- Twitter创建了[Finagle](https://twitter.github.io/finagle)，这是一个Scala库，其所有的微服务都嵌入其中。它处理负载均衡、断路、自动重试、遥测等。
- Netflix开发了[Hystrix](https://github.com/Netflix/Hystrix)，这是一个类似的Java应用库。


## 二、Envoy

Envoy是一个很好的构建模块的原因之一是它支持通过gRPC/REST API进行动态配置。
Envoy之前的开源代理不是为Kubernetes这样的动态环境设计的。它们使用静态的配置文件，需要重新启动才能使配置变化生效。
另外，Envoy提供xDS（*发现服务）API，用于动态配置。它还支持热重启，这使得Envoy可以在不放弃任何活动连接的情况下重新初始化。

Envoy支持通过XDS API进行动态配置。Envoy连接到配置服务器，并使用LDS、RDS、EDS、CDS和其他XDS API请求其配置
Envoy的xDS是一个API集合，包括监听器发现服务（LDS）、集群发现服务（CDS）、端点发现服务（EDS）、路由发现服务（RDS）等。
Envoy配置服务器实现这些API，并作为Envoy的动态配置源。在启动过程中，Envoy会与配置服务器通信（通常是通过gRPC）并订阅配置变化。当环境发生变化时，配置服务器会将变化流向Envoy。


- [Envoy代理](https://www.envoyproxy.io)
- Envoy被用于Ingress控制器 [Contour](https://projectcontour.io)
- [API网关 Amb-assador](https://www.getambassador.io)
- [Gloo](https://docs.solo.io/gloo/)
- [OSM](https://github.com/openservicemesh/osm)



SMI 服务网格结构接口
Istio提供了SMI中所包含的所有功能。
SMI社区维护了一个适配器（https://github.com/servicemeshinterface/smi-adapter-istio），

sidecar模式 Linkerd、Istio

代理节点模式 一个节点部署一个 envoy
遵循这种架构的服务网格包括 Consul Connect（https://www.consul.io/docs/connect）和 Maesh（https://containo.us/maesh）。

